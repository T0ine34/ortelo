
image: node:21-alpine3.18 # all jobs will use this image unless specified otherwise

variables:
  IMAGE_NAME: s3a01/$CI_COMMIT_REF_SLUG   # image tag is the commit hash of the branch (size: 40 chars)
  IMAGE_TAG: $CI_COMMIT_SHA               # other tags can be created on specific events, like the creation of a release
  VOLUME_NAME: s3a01_data                 # name of the volume to mount in the container, allowing data persistence between container restarts
  CONTAINER_NAME: s3a01_container         # name of the container, used to stop and remove the container before deploying a new version


stages:
  - component-test
  - system-test
  - build
  - deploy


# ============================================= tests =============================================

# ------------------------------------------- component -------------------------------------------

html-tests: #this job test if the html files are conform to the w3c validator
  rules:
    - changes:
        - public/**/*
        - .gitlab-ci.yml
  stage: component-test
  image: python:3.11-alpine3.18
  before_script:
    - echo "Setting up html tests"
    - python -m pip install --upgrade pip
    - python -m pip install requests
    - python -m pip install unidecode
  script:
    - echo "Running html tests"
    - python test/html-tests.py public

server-tests: #this job run unit tests for the server
  rules:
    - changes:
        - server/**/*
        - .gitlab-ci.yml
  stage: component-test
  before_script:
    - echo "Setting up server tests"
    - apk add --no-cache make
    - npm install
  script:
    - echo "Running server tests"
    - make server-test

client-tests: #this job run unit tests for the client
  rules:
    - changes:
        - client/**/*
        - .gitlab-ci.yml
  stage: component-test
  before_script:
    - echo "Setting up client tests"
    - apk add --no-cache make
    - npm install
  script:
    - echo "Running client tests"
    - make client-test

# -------------------------------------------- system --------------------------------------------



# ============================================= build =============================================

docker-image-build:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  stage: build
  image: docker:stable
  before_script:
    - docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
  script:
    - echo "Building image"
    - docker build -t $IMAGE_NAME:$IMAGE_TAG -t $IMAGE_NAME:latest .
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - docker push $IMAGE_NAME:latest


# ============================================= deploy =============================================

vps-deploy:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  stage: deploy 
  script:
    - echo "Deploying image"
    - apk add --no-cache sshpass
    - apk add --no-cache openssh-client
    - sshpass -p $VPS_PASSWORD ssh -o StrictHostKeyChecking=no root@lila.vps.boxtoplay.com "docker stop $CONTAINER_NAME || true && docker rm $CONTAINER_NAME || true"
    - sshpass -p $VPS_PASSWORD ssh -o StrictHostKeyChecking=no root@lila.vps.boxtoplay.com "docker run -d -p 5000:3000 --name $CONTAINER_NAME -v $VOLUME_NAME:/data $IMAGE_NAME:$IMAGE_TAG"
