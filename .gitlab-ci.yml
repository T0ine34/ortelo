
image: node:21-alpine3.18 # all jobs will use this image unless specified otherwise

variables:
  # image name is the branch name
  IMAGE_NAME: s3a01/$CI_COMMIT_REF_SLUG
  # image tag is the commit hash of the branch (size: 40 chars)
  IMAGE_TAG: $CI_COMMIT_SHA
  # other tags may be created on specific events, like the creation of a release

  VOLUME_NAME: s3a01_data


stages:
  - test
  - build
  - deploy


server-tests:
  stage: test
  before_script:
    - echo "Setting up server tests"
    - apk add --no-cache make
    - npm install
  script:
    - echo "Running server tests"
    - make server-test

client-tests:
  stage: test
  before_script:
    - echo "Setting up client tests"
    - apk add --no-cache make
    - npm install
  script:
    - echo "Running client tests"
    - make client-test


build-image:
  stage: build
  image: docker:stable
  before_script:
    - docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
  script:
    - echo "Building image"
    - docker build -t $IMAGE_NAME:$IMAGE_TAG -t $IMAGE_NAME:latest .
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - docker push $IMAGE_NAME:latest


deploy-image:
  stage: deploy  
  script:
    - echo "Deploying image"
    - apk add --no-cache sshpass
    - apk add --no-cache openssh-client
    - sshpass -p $VPS_PASSWORD ssh -o StrictHostKeyChecking=no root@lila.vps.boxtoplay.com "docker run -d -p 80:3000 -v $VOLUME_NAME:/data $IMAGE_NAME:$IMAGE_TAG"